name: Build and test
on: push
jobs:
   gfortran:
      runs-on: ubuntu-latest
      steps:
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Clone
        uses: actions/checkout@v2
        with:
           submodules: recursive
           ssh-key: ${{ secrets.BB_TESTING_SSH }}
      - name: Install conda environment
        run: |
          conda env create -f environment.yml
          conda init bash
      - name: Compile
        run: |
          source ${CONDA}/etc/profile.d/conda.sh
          conda activate pygetm
          source ./install
      - name: Run all test cases
        run: |
          source ${CONDA}/etc/profile.d/conda.sh
          conda activate pygetm
          cd python/tests
          python test_2d_transport.py
          python test_2d_flow_symmetry.py
          python test_vertical_diffusion.py
          python test_parallel_advection.py --nrow 1 --ncol 1 --noplot -n 1 -o par_adv_1x1.nc
          mpiexec -n 2 python test_parallel_advection.py --nrow 2 --ncol 1 --noplot -n 1 -o par_adv_2x1.nc
          mpiexec -n 2 python test_parallel_advection.py --nrow 1 --ncol 2 --noplot -n 1 -o par_adv_1x2.nc
          diff -s par_adv_1x1.nc par_adv_2x1.nc
          diff -s par_adv_1x1.nc par_adv_1x2.nc
